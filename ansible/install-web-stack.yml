---
- name: Install and configure web server stack
  hosts: main_ec2
  become: yes
  vars:
    node_version: "18"  # Node.js LTS version
    
  tasks:
    - name: Update system packages
      dnf:
        name: "*"
        state: latest
        update_cache: yes
        
    - name: Install nginx
      dnf:
        name: nginx
        state: present
        
    - name: Start and enable nginx service
      systemd:
        name: nginx
        state: started
        enabled: yes
        
    - name: Install Node.js repository
      shell: |
        curl -fsSL https://rpm.nodesource.com/setup_{{ node_version }}.x | bash -
      args:
        creates: /etc/yum.repos.d/nodesource-el.repo
        
    - name: Install Node.js
      dnf:
        name: nodejs
        state: present
        
    - name: Install PM2 globally via npm
      npm:
        name: pm2
        global: yes
        state: present
        
    - name: Create PM2 startup script
      shell: pm2 startup systemd -u ec2-user --hp /home/ec2-user
      become: yes
      ignore_errors: yes
      
    - name: Create application directory
      file:
        path: /home/ec2-user/app
        state: directory
        owner: ec2-user
        group: ec2-user
        mode: '0755'
        
    - name: Install Git (for cloning repositories)
      dnf:
        name: git
        state: present
        
    - name: Create web directory
      file:
        path: /var/www/html
        state: directory
        owner: nginx
        group: nginx
        mode: '0755'
        
    - name: Configure nginx default site
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/nginx.conf
        backup: yes
      notify: restart nginx
      
    - name: Open HTTP port in firewall (if firewalld is running)
      firewalld:
        port: 80/tcp
        permanent: yes
        state: enabled
        immediate: yes
      ignore_errors: yes
      
    - name: Display installation status
      debug:
        msg: |
          Installation completed successfully!
          - Nginx: Installed and running
          - Node.js: Version {{ node_version }} installed
          - PM2: Installed globally
          - Services are enabled to start on boot
          
  handlers:
    - name: restart nginx
      systemd:
        name: nginx
        state: restarted