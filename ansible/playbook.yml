---
- name: Deploy Vue.js Application with Nginx
  hosts: main_ec2
  become: yes
  gather_facts: false
  vars:
    git_repo: "https://github.com/acpcreation/SinkingCloudsCreative.git"
    
  tasks:
    - name: Update system packages
      raw: sudo yum update -y
      
    - name: Install basic packages
      raw: sudo yum install -y git curl wget --allowerasing
      
    - name: Install Node.js 18.x
      raw: |
        curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
        sudo yum install -y nodejs
        
    - name: Verify Node.js installation
      raw: node --version
      register: node_version
      
    - name: Install and configure Nginx
      raw: |
        sudo yum install -y nginx
        sudo systemctl enable nginx
        
    - name: Clone repository
      raw: |
        rm -rf /tmp/vue-app
        git clone {{ git_repo }} /tmp/vue-app
        
    - name: Build Vue.js application
      raw: |
        cd /tmp/vue-app
        echo "npm install"


    #     sudo npm install
    #     sudo npm run serve
      # npm run build
        
    # - name: Deploy application files
    #   raw: |
    #     sudo mkdir -p /var/www/html
    #     sudo rm -rf /var/www/html/*
    #     sudo cp -r /tmp/vue-app/dist/* /var/www/html/
    #     sudo chown -R nginx:nginx /var/www/html
    #     sudo chmod -R 644 /var/www/html
    #     sudo find /var/www/html -type d -exec chmod 755 {} \;
        
    # - name: Configure Nginx as reverse proxy for app on port 8080
    #   raw: |
    #     sudo tee /etc/nginx/conf.d/default.conf << 'EOF'
    #     server {
    #         listen 80;
    #         server_name _;
            
    #         # Security headers
    #         add_header X-Frame-Options "SAMEORIGIN" always;
    #         add_header X-Content-Type-Options "nosniff" always;
    #         add_header X-XSS-Protection "1; mode=block" always;
            
    #         # Proxy all requests to the app running on port 8080
    #         location / {
    #             proxy_pass http://localhost:8080;
    #             proxy_http_version 1.1;
    #             proxy_set_header Upgrade $http_upgrade;
    #             proxy_set_header Connection 'upgrade';
    #             proxy_set_header Host $host;
    #             proxy_set_header X-Real-IP $remote_addr;
    #             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #             proxy_set_header X-Forwarded-Proto $scheme;
    #             proxy_cache_bypass $http_upgrade;
    #             proxy_read_timeout 300s;
    #             proxy_connect_timeout 75s;
    #         }
            
    #         # Health check endpoint
    #         location /health {
    #             access_log off;
    #             return 200 "healthy\n";
    #             add_header Content-Type text/plain;
    #         }
            
    #         # Security - deny access to hidden files
    #         location ~ /\. {
    #             deny all;
    #         }
    #     }
    #     EOF
        
    # - name: Start Nginx service
    #   raw: |
    #     sudo systemctl start nginx
    #     sudo systemctl reload nginx
        
    # - name: Display deployment status
    #   raw: |
    #     echo "==================================="
    #     echo "Deployment Status:"
    #     echo "==================================="
    #     echo "Node.js version: $(node --version)"
    #     echo "Nginx status: $(sudo systemctl is-active nginx)"
    #     echo "Application URL: http://3.237.76.239"
    #     echo "==================================="
    #     ls -la /var/www/html/
    #     echo "==================================="